name: Jekyll Build & Pages Deploy

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  jekyll:
    runs-on: ubuntu-latest

    steps:
      # Checkout
      - name: Checkout source
        uses: actions/checkout@8ade135a9f8436371f21e14f064e445f5ddf1be3
        # v4.1.7

      # Ruby setup (pinned)
      - name: Set up Ruby
        uses: ruby/setup-ruby@b0f7e9fd9ba6f5b2cb02dbd16e5fbba68a8c76f8
        # v1.183.0
        with:
          ruby-version: "3.2"
          bundler-cache: true

      # Install dependencies
      - name: Install Dependencies
        run: bundle install --retry 3

      # Build Jekyll
      - name: Build Jekyll Site
        run: bundle exec jekyll build --trace

      # Upload Pages artifact (always)
      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@56afc609e8c5fb5d5b443c8f3c32346d7dba3a7a
        # v3.0.1
        with:
          path: _site

      # Deploy ONLY on push to main
      - name: Deploy to GitHub Pages
        id: deploy
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/deploy-pages@4ad835abb3e8f1a6b4f1e47ed64607d680cf4c27
        # v4.0.4

      # PR Preview Deploy (only on PRs)
      - name: Deploy PR Preview
        id: pr_deploy
        if: github.event_name == 'pull_request'
        uses: actions/deploy-pages@4ad835abb3e8f1a6b4f1e47ed64607d680cf4c27
        # v4.0.4

      # Comment PR Preview URL
      - name: Comment PR Preview URL
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@5c3e55c33f1f4c89b32a8a70d312f4042c1c0f05
        # v3.0.2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            üîç **Jekyll PR Preview Ready**

            Preview URL:  
            **${{ steps.pr_deploy.outputs.page_url }}**
